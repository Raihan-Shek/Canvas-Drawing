const canvas=document.getElementById("myCanvas");const ctx=canvas.getContext("2d");const controls=document.querySelector(".controls");const toggleControlsBtn=document.getElementById("toggle-controls");const brushSizeInput=document.getElementById("brushSize");const brushSizeValue=document.getElementById("brushSizeValue");const brushColorInput=document.getElementById("brushColor");const shapeFillInput=document.getElementById("shapeFill");const fillColorInput=document.getElementById("fillColor");const shapeOpacityInput=document.getElementById("shapeOpacity");const shapeOpacityValue=document.getElementById("shapeOpacityValue");const formatSelect=document.getElementById("format");const downloadBtn=document.getElementById("download");const layersPanel=document.getElementById("layersPanel");const undoBtn=document.getElementById("undo");const redoBtn=document.getElementById("redo");const toolButtons=document.querySelectorAll(".tool-group button");const textModal=document.getElementById("textModal");const textInput=document.getElementById("textInput");const confirmTextBtn=document.getElementById("confirmText");const cancelTextBtn=document.getElementById("cancelText");const textFontSizeInput=document.getElementById("textFontSize");const textFontSizeValue=document.getElementById("textFontSizeValue");let pendingTextX=0,pendingTextY=0;const CANVAS_WIDTH=1200;const CANVAS_HEIGHT=800;const HANDLE_SIZE=24;const MIN_SIZE=10;let currentTool="brush";let brushSize=parseInt(brushSizeInput.value);let brushColor=brushColorInput.value;let shapeFill=shapeFillInput.checked;let fillColor=fillColorInput.value;let shapeOpacity=parseFloat(shapeOpacityInput.value);let textFontSize=parseInt(textFontSizeInput.value);let rotationAngle=0;let isDrawing=false;let isDragging=false;let isResizing=false;let resizeCorner=null;let startX=0,startY=0;let offsetX=0,offsetY=0;const layers=[];let activeLayerIndex=-1;const history=[];let historyIndex=-1;let maintainAspect=true;canvas.width=CANVAS_WIDTH;canvas.height=CANVAS_HEIGHT;toggleControlsBtn.addEventListener("click",()=>{controls.classList.toggle("hidden");toggleControlsBtn.textContent=controls.classList.contains("hidden")?"Show Controls":"Toggle Controls"});function getCoords(e){const rect=canvas.getBoundingClientRect();const clientX=e.touches?e.touches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0].clientY:e.clientY;const scaleX=CANVAS_WIDTH/rect.width;const scaleY=CANVAS_HEIGHT/rect.height;return{x:(clientX-rect.left)*scaleX,y:(clientY-rect.top)*scaleY}}brushSizeInput.addEventListener("input",e=>{brushSize=parseInt(e.target.value);brushSizeValue.textContent=brushSize});brushColorInput.addEventListener("input",e=>brushColor=e.target.value);shapeFillInput.addEventListener("input",e=>shapeFill=e.target.checked);fillColorInput.addEventListener("input",e=>fillColor=e.target.value);shapeOpacityInput.addEventListener("input",e=>{shapeOpacity=parseFloat(e.target.value);shapeOpacityValue.textContent=shapeOpacity});textFontSizeInput.addEventListener("input",e=>{textFontSize=parseInt(e.target.value);textFontSizeValue.textContent=textFontSize});toolButtons.forEach(btn=>{btn.addEventListener("click",()=>{currentTool=btn.id.replace("tool","").toLowerCase();toolButtons.forEach(b=>b.classList.remove("active"));btn.classList.add("active");if(layers[layers.length-1]?.type==="drawing"&&isDrawing){handleEnd()}})});document.getElementById("clearCanvas").addEventListener("click",()=>{if(!confirm("Are you sure you want to clear the entire canvas? This cannot be undone by Redo."))return;addToHistory();layers.length=0;activeLayerIndex=-1;redraw();updateLayersPanel()});document.getElementById("uploadImage").addEventListener("change",e=>{const file=e.target.files[0];if(!file)return;const img=new Image;img.onload=()=>{const initialWidth=CANVAS_WIDTH*.5;const initialHeight=img.height*(initialWidth/img.width);addLayer({type:"image",img:img,x:CANVAS_WIDTH/4,y:CANVAS_HEIGHT/4,width:initialWidth,height:initialHeight,opacity:1,visible:true})};img.src=URL.createObjectURL(file)});document.getElementById("layerUp").addEventListener("click",()=>moveLayer(1));document.addEventListener("keydown",e=>{if(e.ctrlKey){if(e.key==="]"){e.preventDefault();moveLayer(1)}}});document.getElementById("layerDown").addEventListener("click",()=>moveLayer(-1));document.addEventListener("keydown",e=>{if(e.ctrlKey){if(e.key==="["){e.preventDefault();moveLayer(-1)}}});undoBtn.addEventListener("click",undo);redoBtn.addEventListener("click",redo);downloadBtn.addEventListener("click",downloadCanvas);confirmTextBtn.addEventListener("click",()=>{const text=textInput.value.trim();if(text){ctx.font=`${textFontSize}px sans-serif`;const textWidth=ctx.measureText(text).width;addLayer({type:"text",text:text,x:pendingTextX,y:pendingTextY,width:textWidth,height:textFontSize*1.2,color:brushColor,fontSize:textFontSize,opacity:shapeOpacity,visible:true})}textModal.style.display="none";textInput.value=""});cancelTextBtn.addEventListener("click",()=>{textModal.style.display="none";textInput.value=""});document.addEventListener("keydown",e=>{if(e.ctrlKey&&e.key==="z"){e.preventDefault();undo()}if(e.ctrlKey&&e.key==="y"){e.preventDefault();redo()}if(e.key==="Shift")maintainAspect=false});document.addEventListener("keyup",e=>{if(e.key==="Shift")maintainAspect=true});function addLayer(layer){addToHistory();layers.push(layer);activeLayerIndex=layers.length-1;redraw();updateLayersPanel()}function moveLayer(direction){if(activeLayerIndex===-1)return;const newIndex=activeLayerIndex+direction;if(newIndex>=0&&newIndex<layers.length){addToHistory();[layers[activeLayerIndex],layers[newIndex]]=[layers[newIndex],layers[activeLayerIndex]];activeLayerIndex=newIndex;redraw();updateLayersPanel()}}const rotationRange=document.getElementById("rotationRange");const rotationValue=document.getElementById("rotationValue");const rotate90ClockwiseBtn=document.getElementById("rotate90Clockwise");rotationRange.addEventListener("input",e=>{rotationAngle=parseInt(e.target.value);rotationValue.textContent=rotationAngle+"°";applyRotation(rotationAngle)});rotationRange.addEventListener("change",()=>{addToHistory()});rotate90ClockwiseBtn.addEventListener("click",()=>{if(activeLayerIndex===-1||layers[activeLayerIndex].type==="drawing")return;addToHistory();const layer=layers[activeLayerIndex];layer.rotation=(layer.rotation||0)+90;if(layer.rotation>180)layer.rotation-=360;rotationAngle=layer.rotation;rotationRange.value=rotationAngle;rotationValue.textContent=rotationAngle+"°";redraw();updateLayersPanel()});function applyRotation(angle){if(activeLayerIndex===-1)return;const layer=layers[activeLayerIndex];if(layer.type!=="drawing"){layer.rotation=angle;redraw()}}function setActiveLayer(index){activeLayerIndex=index;redraw();updateLayersPanel()}function isOverLayer(mx,my,layer){if(layer.type==="drawing")return false;return mx>=layer.x&&mx<=layer.x+layer.width&&my>=layer.y&&my<=layer.y+layer.height}canvas.addEventListener("mousedown",handleStart);canvas.addEventListener("mousemove",handleMove);canvas.addEventListener("mouseup",handleEnd);canvas.addEventListener("mouseleave",handleEnd);canvas.addEventListener("touchstart",handleStart,{passive:false});canvas.addEventListener("touchmove",handleMove,{passive:false});canvas.addEventListener("touchend",handleEnd);function handleStart(e){e.preventDefault();const coords=getCoords(e);startX=coords.x;startY=coords.y;for(let i=layers.length-1;i>=0;i--){const layer=layers[i];if(layer.type==="drawing"||!layer.visible)continue;resizeCorner=getResizeCorner(startX,startY,layer);if(resizeCorner){isResizing=true;setActiveLayer(i);return}if(isOverLayer(startX,startY,layer)){isDragging=true;offsetX=startX-layer.x;offsetY=startY-layer.y;setActiveLayer(i);return}}const activeLayer=layers[activeLayerIndex];if(currentTool==="brush"||currentTool==="eraser"){addLayer({type:"drawing",data:[],color:currentTool==="eraser"?"#ffffff":brushColor,size:brushSize,opacity:1,visible:true});isDrawing=true}else if(["rect","circle","line"].includes(currentTool)){addLayer({type:"shape",shapeType:currentTool,x:startX,y:startY,width:0,height:0,color:brushColor,lineWidth:brushSize,fill:shapeFill,fillColor:fillColor,opacity:shapeOpacity,visible:true});isDrawing=true}else if(currentTool==="text"){pendingTextX=startX;pendingTextY=startY;textModal.style.display="block";textInput.focus()}}function handleMove(e){e.preventDefault();const coords=getCoords(e);const x=coords.x,y=coords.y;const layer=layers[activeLayerIndex];updateCursor(x,y);if(!layer)return;if(isDrawing&&layer.type==="drawing"){layer.data.push({x1:startX,y1:startY,x2:x,y2:y,color:layer.color,size:layer.size});startX=x;startY=y;redraw()}else if(isDragging){layer.x=x-offsetX;layer.y=y-offsetY;redraw()}else if(isResizing){resizeLayer(layer,x,y);redraw()}else if(isDrawing&&layer.type==="shape"){layer.width=x-layer.x;layer.height=y-layer.y;redraw()}}function handleEnd(e){if(isDrawing||isDragging||isResizing){addToHistory();if(isDrawing&&layers[activeLayerIndex].type==="shape"){}}isDrawing=false;isDragging=false;isResizing=false;resizeCorner=null;canvas.style.cursor="crosshair"}function resizeLayer(layer,currentX,currentY){const dx=currentX-startX;const dy=currentY-startY;let newWidth=layer.width;let newHeight=layer.height;let newX=layer.x;let newY=layer.y;let ratio=layer.width/layer.height;if(isNaN(ratio)||!isFinite(ratio))ratio=1;const handleResize=(corner,deltaX,deltaY)=>{let tempX=newX;let tempY=newY;let tempW=newWidth;let tempH=newHeight;switch(corner){case"top-left":tempX=layer.x+deltaX;tempY=layer.y+deltaY;tempW=layer.width-deltaX;tempH=layer.height-deltaY;break;case"top-right":tempY=layer.y+deltaY;tempW=layer.width+deltaX;tempH=layer.height-deltaY;break;case"bottom-left":tempX=layer.x+deltaX;tempW=layer.width-deltaX;tempH=layer.height+deltaY;break;case"bottom-right":tempW=layer.width+deltaX;tempH=layer.height+deltaY;break}if(maintainAspect){if(Math.abs(deltaX)>Math.abs(deltaY)){tempH=tempW/ratio;if(corner.includes("top"))tempY=layer.y+(layer.height-tempH);if(corner.includes("left"))tempX=layer.x+(layer.width-tempW)}else{tempW=tempH*ratio;if(corner.includes("top"))tempY=layer.y+(layer.height-tempH);if(corner.includes("left"))tempX=layer.x+(layer.width-tempW)}}layer.x=tempX;layer.y=tempY;layer.width=Math.max(MIN_SIZE,tempW);layer.height=Math.max(MIN_SIZE,tempH)};handleResize(resizeCorner,dx,dy);if(layer.type==="text"){layer.fontSize=Math.max(MIN_SIZE,layer.height);ctx.font=`${layer.fontSize}px sans-serif`;layer.width=ctx.measureText(layer.text).width}startX=currentX;startY=currentY}function getResizeCorner(mx,my,layer){if(!layer||layer.type==="drawing")return null;const left=layer.x;const top=layer.y;const right=layer.x+layer.width;const bottom=layer.y+layer.height;const hs=HANDLE_SIZE/2;const corners=[{name:"top-left",x:left,y:top},{name:"top-right",x:right,y:top},{name:"bottom-left",x:left,y:bottom},{name:"bottom-right",x:right,y:bottom}];for(const corner of corners){if(mx>=corner.x-hs&&mx<=corner.x+hs&&my>=corner.y-hs&&my<=corner.y+hs){return corner.name}}return null}function getCursorForCorner(corner){const cursors={"top-left":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize","bottom-right":"nwse-resize"};return cursors[corner]||"move"}function updateCursor(x,y){const activeLayer=layers[activeLayerIndex];const handleHover=getResizeCorner(x,y,activeLayer);if(handleHover){canvas.style.cursor=getCursorForCorner(handleHover);return}for(let i=layers.length-1;i>=0;i--){const layer=layers[i];if(layer.type!=="drawing"&&layer.visible&&isOverLayer(x,y,layer)){canvas.style.cursor="move";return}}canvas.style.cursor=["brush","eraser","rect","circle","line"].includes(currentTool)?"crosshair":"default"}function redraw(){ctx.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);layers.forEach((layer,i)=>{if(!layer.visible)return;ctx.globalAlpha=layer.opacity||1;const isInteractive=layer.type!=="drawing";if(isInteractive&&(layer.rotation||0)!==0){ctx.save();const angleRad=layer.rotation*Math.PI/180;const centerX=layer.x+layer.width/2;const centerY=layer.y+layer.height/2;ctx.translate(centerX,centerY);ctx.rotate(angleRad);ctx.translate(-centerX,-centerY)}if(layer.type==="drawing"){layer.data.forEach(seg=>{ctx.strokeStyle=seg.color;ctx.lineWidth=seg.size;ctx.lineCap="round";ctx.beginPath();ctx.moveTo(seg.x1,seg.y1);ctx.lineTo(seg.x2,seg.y2);ctx.stroke()})}else if(layer.type==="image"){if(layer.img.complete){ctx.drawImage(layer.img,layer.x,layer.y,layer.width,layer.height)}}else if(layer.type==="shape"){drawShape(layer)}else if(layer.type==="text"){drawText(layer)}if(i===activeLayerIndex&&isInteractive){ctx.globalAlpha=1;ctx.strokeStyle=varToRgba("--handle-color",.8);ctx.lineWidth=2;ctx.strokeRect(layer.x,layer.y,layer.width,layer.height);ctx.fillStyle=varToRgba("--handle-color",1);const hs=HANDLE_SIZE/2;const corners=[{x:layer.x,y:layer.y},{x:layer.x+layer.width,y:layer.y},{x:layer.x,y:layer.y+layer.height},{x:layer.x+layer.width,y:layer.y+layer.height}];corners.forEach(p=>ctx.fillRect(p.x-hs,p.y-hs,HANDLE_SIZE,HANDLE_SIZE))}if(isInteractive&&(layer.rotation||0)!==0){ctx.restore()}});ctx.globalAlpha=1}function drawShape(layer){ctx.strokeStyle=layer.color;ctx.lineWidth=layer.lineWidth;ctx.beginPath();if(layer.shapeType==="rect"){ctx.rect(layer.x,layer.y,layer.width,layer.height)}else if(layer.shapeType==="circle"){const rx=Math.abs(layer.width/2);const ry=Math.abs(layer.height/2);ctx.ellipse(layer.x+rx,layer.y+ry,rx,ry,0,0,Math.PI*2)}else if(layer.shapeType==="line"){ctx.moveTo(layer.x,layer.y);ctx.lineTo(layer.x+layer.width,layer.y+layer.height);ctx.stroke();return}if(layer.fill){ctx.fillStyle=layer.fillColor;ctx.fill()}ctx.stroke()}function drawText(layer){ctx.fillStyle=layer.color;ctx.font=`${layer.fontSize}px sans-serif`;ctx.textBaseline="top";ctx.fillText(layer.text,layer.x,layer.y);layer.width=ctx.measureText(layer.text).width;layer.height=layer.fontSize*1.2}function varToRgba(cssVar,alpha){const color=getComputedStyle(document.body).getPropertyValue(cssVar).trim();if(color.startsWith("#")){const hex=color.slice(1);const r=parseInt(hex.substring(0,2),16);const g=parseInt(hex.substring(2,4),16);const b=parseInt(hex.substring(4,6),16);return`rgba(${r}, ${g}, ${b}, ${alpha})`}return color}function addToHistory(){if(historyIndex<history.length-1){history.splice(historyIndex+1)}const state=JSON.stringify(layers.map(layer=>({...layer,img:layer.type==="image"?layer.img.src:undefined})));history.push(state);historyIndex=history.length-1;updateHistoryButtons()}function undo(){if(historyIndex<=0)return;historyIndex--;restoreHistory()}function redo(){if(historyIndex>=history.length-1)return;historyIndex++;restoreHistory()}function restoreHistory(){const state=JSON.parse(history[historyIndex]);layers.length=0;activeLayerIndex=-1;state.forEach(layerData=>{if(layerData.type==="image"&&layerData.img){const img=new Image;img.onload=()=>redraw();img.src=layerData.img;layers.push({...layerData,img:img})}else{layers.push(layerData)}});if(layers.length>0)activeLayerIndex=layers.length-1;redraw();updateLayersPanel();updateHistoryButtons()}function updateHistoryButtons(){undoBtn.disabled=historyIndex<=0;redoBtn.disabled=historyIndex>=history.length-1}function updateLayersPanel(){layersPanel.innerHTML="";layers.slice().reverse().forEach((layer,idx)=>{const actualIndex=layers.length-1-idx;const div=document.createElement("div");div.className="layer-item"+(actualIndex===activeLayerIndex?" active":"");const layerInfo=document.createElement("div");layerInfo.className="layer-info";layerInfo.textContent=`${actualIndex+1}. ${layer.type.charAt(0).toUpperCase()+layer.type.slice(1)}${layer.type==="text"?': "'+layer.text.substring(0,15)+(layer.text.length>15?"...":"")+'"':""}`;div.appendChild(layerInfo);div.onclick=()=>setActiveLayer(actualIndex);const btns=document.createElement("span");btns.className="layer-buttons";const delBtn=document.createElement("button");delBtn.textContent="Del";delBtn.onclick=e=>{e.stopPropagation();addToHistory();layers.splice(actualIndex,1);if(activeLayerIndex===actualIndex)activeLayerIndex=Math.min(activeLayerIndex,layers.length-1);else if(activeLayerIndex>actualIndex)activeLayerIndex--;redraw();updateLayersPanel()};const hideBtn=document.createElement("button");hideBtn.textContent=layer.visible?"Hide":"Show";hideBtn.onclick=e=>{e.stopPropagation();addToHistory();layer.visible=!layer.visible;redraw();updateLayersPanel()};const opacitySlider=document.createElement("input");opacitySlider.type="range";opacitySlider.min="0";opacitySlider.max="1";opacitySlider.step="0.01";opacitySlider.value=layer.opacity||1;opacitySlider.className="opacity-slider";opacitySlider.title="Opacity";opacitySlider.oninput=e=>{layer.opacity=parseFloat(e.target.value);redraw()};opacitySlider.onchange=e=>{addToHistory()};btns.appendChild(delBtn);btns.appendChild(hideBtn);layerInfo.appendChild(btns);div.appendChild(opacitySlider);layersPanel.appendChild(div)})}function downloadCanvas(){const format=formatSelect.value.toLowerCase();const filename=`canvas_drawing.${format}`;if(format==="svg"){let svgContent=`<svg xmlns="http://www.w3.org/2000/svg" width="${CANVAS_WIDTH}" height="${CANVAS_HEIGHT}">`;layers.forEach(layer=>{if(!layer.visible||layer.type==="drawing"||layer.type==="image")return;const opacity=layer.opacity||1;if(layer.type==="shape"){const stroke=layer.color;const strokeWidth=layer.lineWidth;const fill=layer.fill?layer.fillColor:"none";if(layer.shapeType==="rect"){svgContent+=`<rect x="${layer.x}" y="${layer.y}" width="${layer.width}" height="${layer.height}" stroke="${stroke}" stroke-width="${strokeWidth}" fill="${fill}" opacity="${opacity}"/>`}else if(layer.shapeType==="circle"){const rx=Math.abs(layer.width/2);const ry=Math.abs(layer.height/2);svgContent+=`<ellipse cx="${layer.x+rx}" cy="${layer.y+ry}" rx="${rx}" ry="${ry}" stroke="${stroke}" stroke-width="${strokeWidth}" fill="${fill}" opacity="${opacity}"/>`}else if(layer.shapeType==="line"){svgContent+=`<line x1="${layer.x}" y1="${layer.y}" x2="${layer.x+layer.width}" y2="${layer.y+layer.height}" stroke="${stroke}" stroke-width="${strokeWidth}" opacity="${opacity}"/>`}}else if(layer.type==="text"){svgContent+=`<text x="${layer.x}" y="${layer.y+layer.fontSize}" fill="${layer.color}" font-size="${layer.fontSize}" opacity="${opacity}" font-family="sans-serif">${layer.text}</text>`}});svgContent+=`</svg>`;const blob=new Blob([svgContent],{type:"image/svg+xml"});triggerDownload(URL.createObjectURL(blob),filename)}else{const merged=document.createElement("canvas");merged.width=CANVAS_WIDTH;merged.height=CANVAS_HEIGHT;const mctx=merged.getContext("2d");layers.forEach(layer=>{if(!layer.visible)return;mctx.globalAlpha=layer.opacity||1;if(layer.type==="drawing"){layer.data.forEach(seg=>{mctx.strokeStyle=seg.color;mctx.lineWidth=seg.size;mctx.lineCap="round";mctx.beginPath();mctx.moveTo(seg.x1,seg.y1);mctx.lineTo(seg.x2,seg.y2);mctx.stroke()})}else if(layer.type==="image"){if(layer.img.complete)mctx.drawImage(layer.img,layer.x,layer.y,layer.width,layer.height)}else if(layer.type==="shape"){mctx.save();mctx.strokeStyle=layer.color;mctx.lineWidth=layer.lineWidth;mctx.beginPath();if(layer.shapeType==="rect"){mctx.rect(layer.x,layer.y,layer.width,layer.height)}else if(layer.shapeType==="circle"){const rx=Math.abs(layer.width/2);const ry=Math.abs(layer.height/2);mctx.ellipse(layer.x+rx,layer.y+ry,rx,ry,0,0,Math.PI*2)}else if(layer.shapeType==="line"){mctx.moveTo(layer.x,layer.y);mctx.lineTo(layer.x+layer.width,layer.y+layer.height);mctx.stroke();mctx.restore();return}if(layer.fill){mctx.fillStyle=layer.fillColor;mctx.fill()}mctx.stroke();mctx.restore()}else if(layer.type==="text"){mctx.save();mctx.fillStyle=layer.color;mctx.font=`${layer.fontSize}px sans-serif`;mctx.textBaseline="top";mctx.fillText(layer.text,layer.x,layer.y);mctx.restore()}});mctx.globalAlpha=1;const mime=format==="jpg"||format==="jpeg"?"image/jpeg":`image/${format}`;triggerDownload(merged.toDataURL(mime,format==="jpeg"?.9:1),filename)}}document.addEventListener("keydown",e=>{const isTyping=e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA";if(e.key==="Delete"&&!isTyping){e.preventDefault();if(activeLayerIndex!==-1&&layers.length>0){addToHistory();layers.splice(activeLayerIndex,1);if(activeLayerIndex>=layers.length){activeLayerIndex=layers.length-1}redraw();updateLayersPanel()}}});function triggerDownload(url,filename){const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);if(url.startsWith("blob:"))URL.revokeObjectURL(url)}addToHistory();redraw();updateLayersPanel();brushSizeValue.textContent=brushSize;shapeOpacityValue.textContent=shapeOpacity;textFontSizeValue.textContent=textFontSize;
